{
  description = "Workstation (zsh+p10k, nvim, LSPs, CLIs)";
  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixpkgs-unstable";
    home-manager = {
      url = "github:nix-community/home-manager";
      inputs.nixpkgs.follows = "nixpkgs";
    };
  };

  outputs = { self, nixpkgs, home-manager, ... }:
  let
    # Allow unfree packages (needed for terraform, etc.)
    mkPkgs = system: import nixpkgs {
      inherit system;
      config.allowUnfree = true;
    };

    # Helper for all architectures
    mkShellFor = system:
      let
        pkgs = mkPkgs system;
      in
      pkgs.mkShell {
        packages = with pkgs; [
          bashInteractive
          gnumake
          coreutils gnused gawk findutils
          git curl wget jq unzip openssh
          neovim tmux lazygit
          eza bat fd ripgrep fzf tree httpie htop
          python312 python312Packages.pip
          nodejs_22 nodePackages.prettier
          nodePackages.typescript-language-server
          pyright bash-language-server
          lua-language-server yaml-language-server marksman
          shellcheck nixfmt-classic tree-sitter
          kubectl terraform awscli2
        ];

        shellHook = ''
          # Local npm / pipx / OMZ setup
          export NPM_CONFIG_PREFIX="$PWD/.npm-global"
          export PATH="$NPM_CONFIG_PREFIX/bin:$PATH"
          export PIPX_HOME="$PWD/.pipx"
          export PIPX_BIN_DIR="$PWD/.pipx/bin"
          export PATH="$PIPX_BIN_DIR:$PATH"
          export ZSH_CUSTOM="$HOME/.oh-my-zsh/custom"

          # Disable nvm in nix shells (conflicts with NPM_CONFIG_PREFIX)
          unset NVM_DIR
          unset -f nvm 2>/dev/null || true

          # Load OpenAI key if available
          if [ -f "$HOME/.openai_api_key" ]; then
            . "$HOME/.openai_api_key"
          elif [ -f ".secrets/openai_api_key" ]; then
            export OPENAI_API_KEY="$(cat .secrets/openai_api_key)"
          fi

          echo "Dev shell ready"
          echo "node: $(node -v) | npm: $(npm -v) | python: $(python3 --version | awk '{print $2}')"
        '';
      };
  in {
    devShells = {
      x86_64-linux.default = mkShellFor "x86_64-linux";
      aarch64-linux.default = mkShellFor "aarch64-linux";
      x86_64-darwin.default = mkShellFor "x86_64-darwin";
      aarch64-darwin.default = mkShellFor "aarch64-darwin";
    };

    # Allow nix fmt to work automatically
    formatter = (mkPkgs "x86_64-linux").nixfmt-classic;

    # Home Manager configs added dynamically by add-home script
    homeConfigurations = { 
      "cobra@linux" = mkHomeCfg { system = "x86_64-linux"; username = "cobra"; homeDir = "/home/cobra"; };
    };
  };
}
