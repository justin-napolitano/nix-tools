#!/usr/bin/env bash
set -euo pipefail
USER_NAME="${USER:-$(id -un)}"; HOME_DIR="${HOME:-$(getent passwd "$USER_NAME" | cut -d: -f6 || echo)}"
UNAME_S="$(uname -s)"; UNAME_M="$(uname -m)"
case "${UNAME_S}_${UNAME_M}" in
  Linux_x86_64)   NIX_SYSTEM="x86_64-linux";   HM_TARGET="${USER_NAME}@linux"  ;; 
  Linux_aarch64)  NIX_SYSTEM="aarch64-linux";  HM_TARGET="${USER_NAME}@linux"  ;; 
  Darwin_x86_64)  NIX_SYSTEM="x86_64-darwin";  HM_TARGET="${USER_NAME}@darwin" ;; 
  Darwin_arm64)   NIX_SYSTEM="aarch64-darwin"; HM_TARGET="${USER_NAME}@darwin" ;; 
  *) echo "Unsupported platform"; exit 1;; 
esac
grep -q ""${HM_TARGET}"" flake.nix && { echo "[add-home] exists"; exit 0; }
awk -v target="${HM_TARGET}" -v sys="${NIX_SYSTEM}" -v user="${USER_NAME}" -v home="${HOME_DIR}" '
  /homeConfigurations = \{/ { print; print "      "" target "" = mkHomeCfg { sys = "" sys ""; username = "" user ""; homeDir = "" home ""; };"; next }
  { print }
' flake.nix > flake.nix.tmp && mv flake.nix.tmp flake.nix
echo "[add-home] OK"
